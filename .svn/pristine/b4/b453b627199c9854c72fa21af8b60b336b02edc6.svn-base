package com.kkl.kklplus.golden.mq.receiver;

import com.kkl.kklplus.golden.entity.GoldenSettlements;
import com.kkl.kklplus.golden.mq.body.MQGoldenOrderCenterMessage;
import com.kkl.kklplus.golden.mq.contans.MQConstant;
import com.kkl.kklplus.golden.service.GoldenSettlementsService;
import com.rabbitmq.client.Channel;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.math.BigDecimal;

@Slf4j
@Component
public class GoldenCenterMessageReceiver {

    @Autowired
    private GoldenSettlementsService goldenSettlementsService;


    @RabbitListener(queues = MQConstant.MQ_TEST_EXCHANGE)
    public void onMessage(Message message, Channel channel) throws Exception {

        try {
            MQGoldenOrderCenterMessage.GoldenOrderCenterMessage goldenOrderCenterMessage =
                    MQGoldenOrderCenterMessage.GoldenOrderCenterMessage.parseFrom(message.getBody());
            log.error("{}", goldenOrderCenterMessage.toString());

            GoldenSettlements goldenSettlements = new GoldenSettlements();
            goldenSettlements.setWithdrawId(goldenOrderCenterMessage.getWithdrawId());
            goldenSettlements.setWithdrawNo(goldenOrderCenterMessage.getWithdrawNo());
            goldenSettlements.setBank(goldenOrderCenterMessage.getBank());
            goldenSettlements.setBankName(goldenOrderCenterMessage.getBankName());
            goldenSettlements.setBankOwner(goldenOrderCenterMessage.getBankOwner());
            goldenSettlements.setBankOwnerIdno(goldenOrderCenterMessage.getBankOwnerIdno());
            goldenSettlements.setBankOwnerPhone(goldenOrderCenterMessage.getBankOwnerPhone());
            goldenSettlements.setPayBy(goldenOrderCenterMessage.getPayBy());
            goldenSettlements.setBankNo(goldenOrderCenterMessage.getBankNo());
            goldenSettlements.setPayForYear(goldenOrderCenterMessage.getPayForYear());
            goldenSettlements.setCertificateType(goldenOrderCenterMessage.getCertificateType());
            goldenSettlements.setPaymentAccount(goldenOrderCenterMessage.getPaymentAccount());
            goldenSettlements.setQuarter(goldenOrderCenterMessage.getQuarter());
            goldenSettlements.setDiscountFlag(goldenOrderCenterMessage.getDiscountFlag());
            goldenSettlements.setInvoiceFlag(goldenOrderCenterMessage.getInvoiceFlag());
            goldenSettlements.setPaymentType(goldenOrderCenterMessage.getPaymentType());
            goldenSettlements.setPayAmount(new BigDecimal(goldenOrderCenterMessage.getPayAmount()));
            goldenSettlements.setServicePointId(goldenOrderCenterMessage.getServicePointId());
            goldenSettlements.setAlipayAccountid(goldenOrderCenterMessage.getAlipayAccountId());
            goldenSettlements.setWxAppid(goldenOrderCenterMessage.getWxAppid());
            goldenSettlements.setWxOpenId(goldenOrderCenterMessage.getWxOpenId());
            goldenSettlements.setApplyAmount(new BigDecimal(goldenOrderCenterMessage.getApplyAmount()));
            goldenSettlements.setPaymentWay(goldenOrderCenterMessage.getPaymentWay());
            goldenSettlements.setPayDate(goldenOrderCenterMessage.getPayDate());
          //  BeanUtils.copyProperties(goldenOrderCenterMessage,goldenSettlement);

            goldenSettlementsService.checkSettlement(goldenSettlements);


        }
        catch (Exception e) {
            e.printStackTrace();
        }finally {
            channel.basicAck(message.getMessageProperties().getDeliveryTag(), false);
        }
    }
}
