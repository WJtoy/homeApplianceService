package com.kkl.kklplus.golden.controller;

import com.google.gson.FieldNamingPolicy;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.kkl.kklplus.golden.commonEnum.GoldenProcessFlag;
import com.kkl.kklplus.golden.commonEnum.ProcessFlagEnum;
import com.kkl.kklplus.golden.commonEnum.SettlementEnum;
import com.kkl.kklplus.golden.commonEnum.SubSettlementEnum;
import com.kkl.kklplus.golden.entity.GoldenCallbackLog;
import com.kkl.kklplus.golden.entity.GoldenSettlements;
import com.kkl.kklplus.golden.entity.GoldenSysLog;
import com.kkl.kklplus.golden.entity.callback.RefundParam;
import com.kkl.kklplus.golden.entity.callback.RequestCallbackParam;
import com.kkl.kklplus.golden.http.config.GoldenProperties;

import com.kkl.kklplus.golden.mq.sender.GoldenCenterMessageSender;
import com.kkl.kklplus.golden.mq.sender.GoldenSettlementMessageSender;
import com.kkl.kklplus.golden.service.CallbackLogService;
import com.kkl.kklplus.golden.service.GoldenSettlementsService;
import com.kkl.kklplus.golden.service.GoldenSysLogService;
import com.kkl.kklplus.golden.utils.AesUtil;
import com.kkl.kklplus.golden.utils.GsonUtils;
import com.kkl.kklplus.golden.utils.QuarterUtils;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.Date;


@Slf4j
@RestController
@RequestMapping("/api/callback/")
public class SettlementsCallbackController {


    @Autowired
    private GoldenSettlementsService goldenSettlementsService;

    @Autowired
    private GoldenProperties goldenProperties;

    @Autowired
    private GoldenSysLogService goldenSysLogService;

    @Autowired
    private CallbackLogService callbackLogService;

    /**
     *支付回调接口
     * @param req
     * @return
     * @throws IOException
     */
    @PostMapping(value = "payment")
    public String payment(HttpServletRequest req) throws IOException{
        String json = readReq(req);
        GsonBuilder gsonBuilder = new GsonBuilder();
        gsonBuilder.setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES);
        Gson gson = gsonBuilder.create();
        try {
            RequestCallbackParam requestCallbackParam = gson.fromJson(json,RequestCallbackParam.class);
            goldenSettlementsService.goldenSettlement(requestCallbackParam);
        }catch (Exception e){
            GoldenSysLog goldenSysLog = new GoldenSysLog();
            goldenSysLog.setTitle("参数解析失败");
            goldenSysLog.setParams(json);
            goldenSysLog.setCreateDate(System.currentTimeMillis());
            goldenSysLog.setCreateBy(1L);
            goldenSysLog.setRequestUri("/callback/payment");
            goldenSysLog.setQuarter(QuarterUtils.getQuarter(new Date()));
            goldenSysLog.setType(1);
            goldenSysLogService.insertModel(goldenSysLog);
        }

        return "success";
    }

    /**
     * 退款回调接口
     * @param req
     * @return
     * @throws IOException
     */
    @PostMapping (value = "refund")
    public String refund(HttpServletRequest req) throws IOException {
        String json = readReq(req);
        try {
            RequestCallbackParam requestParam = GsonUtils.getInstance().fromJson(json, RequestCallbackParam.class);
            GoldenProperties.GoldenDataConfig goldenDataConfig = goldenProperties.getGoldenDataConfig();
                String data = requestParam.getData();
                if (StringUtils.isNotBlank(data)) {
                    String aesStr = AesUtil.decrypt(data, goldenDataConfig.getAppSecret()); // 解密
                    if (aesStr.isEmpty()){
                        GoldenSysLog goldenSysLog = new GoldenSysLog();
                        goldenSysLog.setCreateBy(1L);
                        goldenSysLog.setTitle("解密失败");
                        goldenSysLog.setType(1);
                        goldenSysLog.setParams(requestParam.getData());
                        goldenSysLog.setCreateDate(System.currentTimeMillis());
                        goldenSysLog.setQuarter(QuarterUtils.getQuarter(new Date()));
                        goldenSysLog.setRequestUri("/callback/payment");
                        goldenSysLogService.insertModel(goldenSysLog);
                        return "success";
                    }
                    RefundParam refundParam =  GsonUtils.getInstance().fromJson(aesStr, RefundParam.class);
                    GoldenSettlements goldenSettlements = new GoldenSettlements();
                    goldenSettlements.setWithdrawNo(refundParam.getOrderRandomCode());
                    GoldenSettlements goldenSettlements1 = goldenSettlementsService.selectById(goldenSettlements);
                    GoldenCallbackLog goldenCallbackLog = new GoldenCallbackLog();
                    goldenCallbackLog.setCreateBy(1L);
                    goldenCallbackLog.setCreateDate(System.currentTimeMillis());
                    goldenCallbackLog.setQuarter(QuarterUtils.getQuarter(new Date()));
                    goldenCallbackLog.setSettlementId(goldenSettlements1.getId());
                    goldenCallbackLog.setInfoJson(json);
                    goldenCallbackLog.setWithdrawNo(goldenSettlements1.getWithdrawNo());
                    callbackLogService.insert(goldenCallbackLog);
                    if (requestParam.getCode() == 0) {  //  退款成功
                            goldenSettlements1.setSubStatus(SubSettlementEnum.SUCCESS_REFUND.getValue());
                            goldenSettlements1.setUpdateDate(System.currentTimeMillis());
                            goldenSettlements1.setId(goldenSettlements.getId());
                            goldenSettlements1.setRefundMerchantAmount(refundParam.getRefundMerchantAmount());
                            goldenSettlements1.setRefundServiceAmount(refundParam.getRefundServiceAmount());
                            goldenSettlements1.setChangeCode(refundParam.getChangeCode());
                            goldenSettlements1.setChangeMerchantAmount(refundParam.getChangeMerchantAmount());
                            goldenSettlements1.setChangeServiceAmount(refundParam.getChangeServiceAmount());
                            goldenSettlements1.setSettlementCode(refundParam.getSettlementCode());
                            goldenSettlementsService.updateReqResult(goldenSettlements);
                            goldenCallbackLog.setId(goldenCallbackLog.getId());
                            goldenCallbackLog.setProcessFlag(GoldenProcessFlag.PROCESS_FLAG_SUCCESS.value);
                            callbackLogService.insert(goldenCallbackLog);

                    }else{      //退款失败
                        goldenCallbackLog.setId(goldenCallbackLog.getId());
                        goldenCallbackLog.setProcessFlag(GoldenProcessFlag.PROCESS_FLAG_FAILURE.value);
                        callbackLogService.insert(goldenCallbackLog);
                        goldenSettlements1.setSubStatus(SubSettlementEnum.FAIL_REFUND.getValue());
                        goldenSettlements1.setUpdateDate(System.currentTimeMillis());
                        goldenSettlements1.setId(goldenSettlements.getId());
                        goldenSettlementsService.updateReqResult(goldenSettlements);

                    }
            }
        }catch (Exception e){
            log.error("refund:json转化异常:{}",json,e);
        }
        return "success";
    }

    public String readReq(HttpServletRequest req) throws IOException {
        // 读取参数
        InputStream inputStream;
        StringBuffer sb = new StringBuffer();
        inputStream = req.getInputStream();
        String s;
        BufferedReader in = new BufferedReader(new InputStreamReader(inputStream, "UTF-8"));
        while ((s = in.readLine()) != null) {
            sb.append(s);
        }
        in.close();
        inputStream.close();
        String json = sb.toString();
        return json;
    }
}
