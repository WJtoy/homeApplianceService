package com.kkl.kklplus.golden.controller;

import com.google.gson.FieldNamingPolicy;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.kkl.kklplus.common.exception.MSErrorCode;
import com.kkl.kklplus.common.response.MSResponse;
import com.kkl.kklplus.golden.commonEnum.GoldenProcessFlag;
import com.kkl.kklplus.golden.commonEnum.SettlementEnum;
import com.kkl.kklplus.golden.commonEnum.SubSettlementEnum;
import com.kkl.kklplus.golden.entity.GoldenProcessLog;
import com.kkl.kklplus.golden.entity.GoldenSettlements;
import com.kkl.kklplus.golden.http.command.OperationCommand;
import com.kkl.kklplus.golden.http.config.GoldenProperties;
import com.kkl.kklplus.golden.http.request.CommonParam;
import com.kkl.kklplus.golden.http.request.RefundBalance;
import com.kkl.kklplus.golden.http.response.ResponseBody;
import com.kkl.kklplus.golden.http.utils.OkHttpUtils;
import com.kkl.kklplus.golden.service.GoldenSettlementsService;
import com.kkl.kklplus.golden.service.GoldenSysLogService;
import com.kkl.kklplus.golden.service.ProcesslogService;
import com.kkl.kklplus.golden.utils.GsonUtils;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@Api(tags = "结算单操作接口")
@Slf4j
@RestController
@RequestMapping("/settlements/")
public class SettlementsController {

    @Autowired
    private GoldenSettlementsService settlementsService;

    @Autowired
    private GoldenSysLogService sysLogService;

    @Autowired
    private ProcesslogService processlogService;

    @Autowired
    private GoldenProperties goldenProperties;


    private static Gson gson = new GsonBuilder().setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES).create();

    @ApiOperation("关闭退款")
    @GetMapping("closeRefund/{id}/{updateById}")
    public MSResponse<Integer> closeRefund(@PathVariable("id")Long id,@PathVariable("updateById")Long updateById) {
        try {
            Integer count = settlementsService.closeRefund(id, updateById, System.currentTimeMillis());
            return new MSResponse(MSErrorCode.SUCCESS,count);
        }catch (Exception e){
            log.error("关闭退款异常:{}",id,e);
            sysLogService.insert(updateById,id.toString(), e.getMessage(),
                    "关闭退款异常","settlements/closeRefund", "GET");
            return new MSResponse(new MSErrorCode(1000, StringUtils.left(e.getMessage(),200)),0);
        }
    }

    @ApiOperation("批量查询付款单对应的结算单的状态及其异常原因")
    @PostMapping("batchSearchSettlementsByWithdrawIds")
    public MSResponse<Map<Long, GoldenSettlements>> batchSearchSettlementsByWithdrawIds(@RequestBody List<Long> withdrawIds) {
        try {
            Map<Long,GoldenSettlements> settlementsMap =
                    settlementsService.batchSearchSettlementsByWithdrawIds(withdrawIds);
            return new MSResponse(MSErrorCode.SUCCESS,settlementsMap);
        }catch (Exception e){
            String gson = GsonUtils.getInstance().toGson(withdrawIds);
            log.error("批量查询付款单对应的结算单异常:{}",gson,e);
            sysLogService.insert(1L,gson, e.getMessage(),
                    "批量查询付款单对应的结算单异常","settlements/batchSearchSettlementsByWithdrawIds", "POST");
            return new MSResponse(new MSErrorCode(1000, StringUtils.left(e.getMessage(),200)));
        }
    }

    @ApiOperation("结算单重发接口")
    @PostMapping("settlementsRetry")
    public MSResponse<Integer> settlementsRetry(@RequestBody GoldenSettlements settlements) {
        try {
            return settlementsService.settlementsRetry(settlements);
        }catch (Exception e){
            String gson = GsonUtils.getInstance().toGson(settlements);
            log.error("结算单重发异常:{}",gson,e);
            sysLogService.insert(1L,gson, e.getMessage(),
                    "结算单重发异常","settlements/settlementsRetry", "POST");
            return new MSResponse(new MSErrorCode(1000, StringUtils.left(e.getMessage(),200)));
        }
    }


    @ApiOperation("手动退款")
    @PostMapping("manualRefund")
    public MSResponse<Integer> manualRefund(@RequestBody GoldenSettlements goldenSettlements3) {
        try {
            GoldenSettlements goldenSettlements = settlementsService.selectById(goldenSettlements3);
            if (goldenSettlements != null){

                RefundBalance refundBalance = new RefundBalance();
                refundBalance.setOrderRandomCode(goldenSettlements.getWithdrawNo());
                String infoJson = gson.toJson(refundBalance);

                GoldenProcessLog processlog = new GoldenProcessLog();
                processlog.setQuarter(goldenSettlements.getQuarter());
                processlog.setProcessTime(1);
                processlog.setProcessFlag(1);
                processlog.setCreateBy(1L);
                processlog.setCreateDate(System.currentTimeMillis());
                processlog.setUpdateDate(System.currentTimeMillis());
                processlog.setUpdateBy(1L);
                processlog.setSettlementId(goldenSettlements.getId());
                processlog.setInfoJson(infoJson);
                processlog.setInterfaceName("/settlements/manualRefund");
                processlog.setWithdrawNo(goldenSettlements.getWithdrawNo());
                processlogService.insert(processlog);

                CommonParam commonParam = new CommonParam();
                commonParam.setRequestId(String.valueOf(processlog.getId()));
                commonParam.setCallBackUrl(goldenProperties.getCallbackUrl()+"/api/callback/refund");
                commonParam.setTime(processlog.getCreateDate());
                //组合请求
                OperationCommand command = OperationCommand.newInstance(OperationCommand.OperationCode.REFUNDBALANCE, refundBalance);
                ResponseBody<ResponseBody> resBody = OkHttpUtils.postSyncGenericNew(command, ResponseBody.class, commonParam);
                ResponseBody data = resBody.getData();
                GoldenProcessLog goldenProcessLog = new GoldenProcessLog();
                goldenProcessLog.setId(processlog.getId());

                if (resBody.getCode() == 0 && data != null && data.getCode() == 0) {

                    goldenProcessLog.setResultJson(resBody.getOriginalJson());
                    goldenProcessLog.setProcessFlag(GoldenProcessFlag.PROCESS_FLAG_SUCCESS.value);
                    goldenProcessLog.setUpdateDate(System.currentTimeMillis());
                    processlogService.updateProcessFlag(goldenProcessLog);

                    goldenSettlements.setStatus(SettlementEnum.PROCESS.getValue());
                    goldenSettlements.setSubStatus(SubSettlementEnum.PROCESS.getValue());
                    goldenSettlements.setUpdateDate(System.currentTimeMillis());
                    settlementsService.updateResult(goldenSettlements);

                } else {
                    String errorMsg = resBody.getMsg();
                    if (data != null) {
                        errorMsg = data.getMsg();
                    }
                    errorMsg = StringUtils.left(errorMsg, 200);
                    goldenSettlements.setProcessComment(errorMsg);
                    goldenSettlements.setUpdateDate(System.currentTimeMillis());
                    goldenSettlements.setSubStatus(SubSettlementEnum.REQ_EXCEPTION.getValue());

                    settlementsService.updateResult(goldenSettlements);
                    goldenProcessLog.setProcessFlag(GoldenProcessFlag.PROCESS_FLAG_FAILURE.value);
                    goldenProcessLog.setProcessComment(errorMsg);
                    processlogService.updateProcessFlag(goldenProcessLog);
                    return new MSResponse(new MSErrorCode(MSErrorCode.FAILURE.getCode(), StringUtils.left(errorMsg,200)));
                }
            }else{
                return new MSResponse(new MSErrorCode(1000, StringUtils.left("该结算单不存在",200)));
            }
            return new MSResponse(MSErrorCode.SUCCESS, "");
        }catch (Exception e){
            String gson = GsonUtils.getInstance().toGson(goldenSettlements3.getId());
            log.error("结算单退款异常:{}",gson,e);
            sysLogService.insert(1L,gson, e.getMessage(),
                    "结算单退款异常","settlements/manualRefund", "POST");
            return new MSResponse(new MSErrorCode(1000, StringUtils.left(e.getMessage(),200)));
        }
    }



}
