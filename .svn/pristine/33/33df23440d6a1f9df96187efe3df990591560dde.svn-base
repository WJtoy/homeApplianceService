package com.kkl.kklplus.golden.controller;

import com.google.gson.FieldNamingPolicy;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.kkl.kklplus.golden.commonEnum.SettlementEnum;
import com.kkl.kklplus.golden.entity.GoldenSysLog;
import com.kkl.kklplus.golden.entity.callback.RefundParam;
import com.kkl.kklplus.golden.entity.callback.RequestCallbackParam;
import com.kkl.kklplus.golden.http.config.GoldenProperties;

import com.kkl.kklplus.golden.mq.sender.GoldenCenterMessageSender;
import com.kkl.kklplus.golden.mq.sender.GoldenSettlementMessageSender;
import com.kkl.kklplus.golden.service.GoldenSettlementsService;
import com.kkl.kklplus.golden.service.GoldenSysLogService;
import com.kkl.kklplus.golden.utils.AesUtil;
import com.kkl.kklplus.golden.utils.GsonUtils;
import com.kkl.kklplus.golden.utils.QuarterUtils;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.Date;


@Slf4j
@RestController
@RequestMapping("/api/callback/")
public class SettlementsCallbackController {


    @Autowired
    private GoldenSettlementsService goldenSettlementsService;

    @Autowired
    private GoldenProperties goldenProperties;

    @Autowired
    private GoldenSysLogService goldenSysLogService;

    @PostMapping(value = "payment")
    public String payment(HttpServletRequest req) throws IOException{
        String json = readReq(req);
        GsonBuilder gsonBuilder = new GsonBuilder();
        gsonBuilder.setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES);
        Gson gson = gsonBuilder.create();
        try {
            RequestCallbackParam requestCallbackParam = gson.fromJson(json,RequestCallbackParam.class);
            goldenSettlementsService.goldenSettlement(requestCallbackParam);
        }catch (Exception e){
            GoldenSysLog goldenSysLog = new GoldenSysLog();
            goldenSysLog.setTitle("参数解析失败");
            goldenSysLog.setParams(json);
            goldenSysLog.setCreateDate(System.currentTimeMillis());
            goldenSysLog.setCreateBy(1L);
            goldenSysLog.setRequestUri("/callback/payment");
            goldenSysLog.setQuarter(QuarterUtils.getQuarter(new Date()));
            goldenSysLog.setType(1);
            goldenSysLogService.insertModel(goldenSysLog);
        }

        return "success";
    }


    @PostMapping (value = "refund")
    public String refund(HttpServletRequest req) throws IOException {
        String json = readReq(req);
        try {
            RequestCallbackParam requestParam = GsonUtils.getInstance().fromJson(json, RequestCallbackParam.class);
            GoldenProperties.GoldenDataConfig goldenDataConfig = goldenProperties.getGoldenDataConfig();
            if (requestParam.getCode() == 0) {
                String data = requestParam.getData();
                if (StringUtils.isNotBlank(data)) {
                    String aesStr = AesUtil.decrypt(data, goldenDataConfig.getAppSecret());
                    RefundParam refundParam =  GsonUtils.getInstance().fromJson(aesStr, RefundParam.class);

                }else{

                }
            }
        }catch (Exception e){
            log.error("refund:json转化异常:{}",json,e);
        }
        return "success";
    }

    public String readReq(HttpServletRequest req) throws IOException {
        // 读取参数
        InputStream inputStream;
        StringBuffer sb = new StringBuffer();
        inputStream = req.getInputStream();
        String s;
        BufferedReader in = new BufferedReader(new InputStreamReader(inputStream, "UTF-8"));
        while ((s = in.readLine()) != null) {
            sb.append(s);
        }
        in.close();
        inputStream.close();
        String json = sb.toString();
        return json;
    }
}
